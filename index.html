<!DOCTYPE html>
<html>
<head>
	<title>Twitch Chat</title>	
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://cdn.rawgit.com/tmijs/cdn/1c25be29/1.2.1/tmi.js"></script>
	<script src="config.default.js"></script>
	<script src="config.local.js"></script>
	<style type="text/css">
		html *, * {
			box-sizing: border-box;
		}
		body {
			background: #222;
			margin: 0;
			font-family: Arial;
			font-size: 12px;
		}
		main {
			position: absolute;
			height: 100%;
			width: 100%;
			overflow: hidden;
			padding-bottom: 50px;
		}
		#messages {
			position: relative;
			height: 100%;
			padding: 10px;
			color: #eee;
			overflow-x: hidden;
			overflow-y: scroll;
		}
		#messages .message {
			padding: 3px;
		}
		#messages #message-template {
			display: none;
		}
		#messages .message-time {
			color: #666;
		}
		#messages .message-user {
			font-weight: bold;
			color: #7af;
		}
		#messages .message-debug {
			font-size: 11px;
			color: #aaa;
		}
		#input {
			position: absolute;
			bottom: 0px;
			width: 100%;
			height: 50px;
			border-top: 1px solid #333;
			padding: 10px;
			font-size: 0px;
		}
		#input #input-message {
			display: inline-block;
			width: 95%;
			height: 100%;
			font-size: 12px;
			background: #2f2f2f;
			color: #eee;
		}
		#input #input-submit {
			display: inline-block;
			vertical-align: top;
			width: 5%;
			height: 100%;
			font-size: 12px;
		}
	</style>
</head>
<body>
	<main>
		<div id="messages">
			<div class="message" id="message-template">
				<span class="message-time"></span>
				<span class="message-user">
					<span class="message-username"></span>:
				</span>
				<span class="message-text"></span>
				<span class="message-debug"></span>
			</div>
		</div>
		<div id="input">
			<textarea id="input-message" onkeypress="onInputFieldKeyPress(event);"></textarea>
			<input type="submit" id="input-submit" value="Send" onclick="onSendButtonClick();" />
		</div>
	</main>

	<script type="text/javascript">
		// Start client
		var client = new tmi.client({
			options: {
				clientId: CLIENT_ID,
				debug: true
			},
			connection: {
				reconnect: true,
			},
			identity: {
				username: USERNAME,
				password: "oauth:" + OAUTH_TOKEN,
			},
			channels: ['#' + CHANNEL],
		});

		client.connect();

		/**
		 * Message from server handler
		 */
		client.on("message", function(channel, userstate, message, self) {
			switch (userstate['message-type']) {
				case 'chat':
					onChatMessage(channel, userstate, message, self);
					break;
				default:
					break;
			}
		});

		/**
		 * A standard message (someone typed in chat)
		 */
		function onChatMessage(channel, userstate, message, self) {
			if (self)
				return;

			appendMessage(
				userstate['username'],
				userstate['display-name'],
				userstate['color'],
				('tmi-sent-ts' in userstate) ? parseInt(userstate['tmi-sent-ts']) : -1,
				message);
		}

		function appendMessage(username, displayName, color, timestamp, message) {
			var messageElems = $('#messages .message').not('#message-template');

			// If timestamp not given, use current latest timestamp
			if (timestamp == -1) {
				if (messageElems.length > 0) {
					var lastMessageIdData = decodeMessageId(messageElems.last().attr('id'));
					timestamp = lastMessageIdData.timestamp;
				}
				else {
					// No messages yet. First message will get timestamp 0
					timestamp = 0;
				}
			}
			
			var newMessageElem = $('#message-template').clone();
			newMessageElem.attr('id', encodeMessageId(username, timestamp));
			newMessageElem.find('.message-time').text(formatTimestamp(timestamp));
			newMessageElem.find('.message-user').css('color', color);
			newMessageElem.find('.message-username').text(displayName);
			newMessageElem.find('.message-text').text(message);
			//newMessageElem.find('.message-debug').text("(" + (currentTimeMillis() - timestamp) + "ms)");

			// Insert message where it belongs (based on original timestamp)
			// Since they're already sorted, we can traverse them in DOM order
			var insertAfter = null;
			for (var i = 0; i < messageElems.length; ++i) {
				var messageIdData = decodeMessageId(messageElems[i].id);
				if (insertAfter == null || timestamp >= messageIdData.timestamp)
					insertAfter = messageElems[i];
				else if (timestamp < messageIdData.timestamp)
					break;
			}

			var messages = $('#messages');

			var scrollBottom = messages.scrollTop() + messages.prop('offsetHeight');
			var wasScrolledUp = (scrollBottom < messages.prop('scrollHeight') - 10);

			if (insertAfter != null)
				$(insertAfter).after(newMessageElem);
			else
				messages.append(newMessageElem);

			// Scroll to bottom
			if (!wasScrolledUp) {
				messages.scrollTop(messages.prop('scrollHeight'));
			}

			// Remove old messages
			var numMessages = messageElems.length + 1; // + 1 for new message
			if (numMessages > MAX_MESSAGES) {
				$('#messages .message').not('#message-template').slice(0, numMessages - MAX_MESSAGES).remove();
			}
		}

		/**
		 * Send current message to channel
		 */
		function sendCurrentMessage() {
			var message = $('#input-message').val();
			client.say(CHANNEL, message);

			// Immediately show message
			appendMessage(
				USERNAME,
				client.globaluserstate['display-name'],
				client.globaluserstate['color'],
				-1,
				message);

			// Reset input
			$('#input-message').val("");
		}

		/**
		 * Send button click handler
		 */
		function onSendButtonClick() {
			sendCurrentMessage();
		}

		/**
		 * Input field KeyPress handler
		 */
		function onInputFieldKeyPress(event) {
			if (event.keyCode == 13) {
				sendCurrentMessage();
				event.preventDefault();
			}
		}


		function encodeMessageId(username, timestamp) {
			return username + ":" + timestamp;
		}

		function decodeMessageId(messageId) {
			var parts = messageId.split(":");
			return {
				username: parts[0],
				timestamp: parts[1]
			}
		}


		function currentTimeMillis() {
			return +new Date();
		}

		function formatTimestamp(millis) {
			var date = new Date(millis);
			return date.getHours()
				+ ":" + padZeros(date.getMinutes(), 2)
				+ ":" + padZeros(date.getSeconds(), 2)
				+ "." + padZeros(date.getMilliseconds(), 2);
		}

		function padZeros(num, size) {
			var s = num+"";
			while (s.length < size) s = "0" + s;
			return s;
		}
	</script>
</body>
</html>
